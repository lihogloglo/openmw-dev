# Snow Deformation RTT Debug Tracker

**Objective:** Fix the regression in the snow deformation system where the entire RTT area is being depressed instead of just footprints.

**Current Status:** CRITICAL - Texture Binding Failure Confirmed

---

## Critical Findings (Session 4)

### 1. The "Red Area" / Full Depression is NOT from the Update Shader
-   We modified `snow_update.frag` to force output to **Black (0.0)**.
-   **Result:** The "Red Area" (and full depression) **PERSISTED**.
-   **Conclusion:** The `terrain.frag` shader is **NOT reading the texture generated by our RTT system**.
-   It is likely reading a **Default White Texture** or a **Depth Texture** (all 1.0) bound to Texture Unit 7.

### 2. Vertex Raising Logic is Correct
-   Disabling `vertex.z += baseLift` flattened the terrain.
-   Re-enabling it returned the "pushed down everywhere" behavior.
-   This confirms the shader logic is working, but the input `vDeformationFactor` is consistently 1.0 (White).

### 3. Debug Overlay Implemented but Invisible
-   We implemented a `DebugOverlay` class (HUD) to show the textures.
-   **Result:** User reports the overlay is **NOT visible**.
-   This needs to be fixed to verify if the RTT textures themselves are correct (Black with footprints) or if they are also broken.

---

## Next Steps (Handover)

### 1. Fix Texture Binding (High Priority)
-   The Terrain Shader is reading "White" regardless of what we write to the RTT.
-   **Investigate:** `SnowDeformationUpdater::apply` and `Terrain::StateSetUpdater`.
-   **Hypothesis:**
    -   Texture Unit 7 is being overwritten by something else.
    -   The `mDeformationMapUniform` is not correctly pointing to Unit 7.
    -   The texture object being bound is not the one we think it is.

### 2. Fix Debug Overlay
-   The overlay camera is attached to `mRootNode`.
-   It might need to be attached higher up (e.g., SceneManager root) or have culling disabled explicitly.
-   Once visible, it will tell us if the **Input** (Object Mask) and **Output** (Accumulation) are correct.

---

## Investigation History (Archive)

### Phase 1: Initial Investigation
-   Texture binding fixes, unit scale correction.

### Phase 2: Depth Camera
-   Identified CullCallback issues (superseded).

### Phase 3: Shader Isolation (Session 4)
-   **Force Black:** Failed to change output.
-   **Bypass Blur:** Failed to change output.
-   **Conclusion:** The link between RTT and Terrain is broken.

---

**Last Updated:** 2025-11-30
**Session:** 4 (Texture Binding Investigation)

## Executed Fixes & Tests (Session 4)

### 1. Debug Overlay Fix
-   **Action:** Disabled culling for `DebugOverlay` camera.
-   **Goal:** Ensure debug overlay is visible.

### 2. Terrain Shader Debug Visualization
-   **Action:** Modified `terrain.frag` to output raw `snowDeformationMap` (Unit 7) to `gl_FragData[0]`.
-   **Goal:** See exactly what the terrain shader is reading.

### 3. RTT Execution & Pipeline Verification
-   **Action A (Execution):** Disabled culling for `mUpdateCamera`, `mBlurHCamera`, and `mBlurVCamera` in `SnowSimulation.cpp`.
-   **Action B (Initialization):** Explicitly initialized `mAccumulationMap` (Ping-Pong buffers) to **GREEN (0, 1, 0, 1)**.
-   **Action C (Pipeline):** Forced `snow_update.frag` to output **RED (1.0, 0.0, 0.0, 1.0)**.
-   **Action D (Bypass):** Modified `SnowDeformationManager` to bypass the Blur pass and return `mAccumulationMap` directly.

### 4. Final Result: WHITE TERRAIN
-   **Observation:** The terrain rendered as **Solid White**.
-   **Analysis:**
    -   It is **NOT RED** -> The RTT update (Red) is not reaching the terrain.
    -   It is **NOT GREEN** -> The initial texture content (Green) is not reaching the terrain.
    -   **CONCLUSION:** The Terrain Shader is **NOT SAMPLING OUR TEXTURE**.
    -   It is sampling a **Default White Texture** on Unit 7 (or Unit 7 is not bound, and it falls back to white).

## Next Steps (Session 5: Binding Fix)
**Goal:** Fix the Texture Binding on Unit 7.

**Hypotheses:**
1.  **StateSet Overwrite:** `SnowDeformationUpdater::apply` is not being called, or its changes to Unit 7 are being overwritten by `Terrain::StateSetUpdater` or `Chunk` rendering.
2.  **Uniform Mismatch:** The uniform `snowDeformationMap` is not actually set to 7, or the shader is optimizing it away/reassigning it.
3.  **Texture Object Mismatch:** The `osg::Texture2D*` we are binding is not the one we are writing to (pointer mismatch).

**Action Plan:**
1.  **Investigate `SnowDeformationUpdater::apply`:** Add logs to confirm it runs and binds the texture.
2.  **Investigate `Terrain::StateSetUpdater`:** Check if it clears or overwrites texture attributes.
3.  **Force Binding in `Terrain::Chunk`:** Try binding the texture directly to the Chunk StateSet instead of the global Terrain StateSet.
